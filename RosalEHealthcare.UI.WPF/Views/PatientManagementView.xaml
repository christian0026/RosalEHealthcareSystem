<UserControl x:Class="RosalEHealthcare.UI.WPF.Views.PatientManagementView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:local="clr-namespace:RosalEHealthcare.UI.WPF.Controls"
             Background="#F5F5F5">

    <UserControl.Resources>
        <Style x:Key="ActionBtn" TargetType="Button">
            <Setter Property="Height" Value="32"/>
            <Setter Property="Padding" Value="10,6"/>
            <Setter Property="Margin" Value="4,0"/>
            <Setter Property="FontSize" Value="12"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border Background="{TemplateBinding Background}" 
                                CornerRadius="6" 
                                Padding="{TemplateBinding Padding}">
                            <ContentPresenter HorizontalAlignment="Center" 
                                            VerticalAlignment="Center"/>
                        </Border>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
            <Style.Triggers>
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="Opacity" Value="0.85"/>
                </Trigger>
            </Style.Triggers>
        </Style>
    </UserControl.Resources>

    <!-- SINGLE root container (Grid) so UserControl.Content is set only once -->
    <Grid>
        <ScrollViewer VerticalScrollBarVisibility="Auto">
            <StackPanel Margin="20">
                <!-- Summary Cards -->
                <Grid Margin="0,0,0,20">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>

                    <local:SummaryCard Grid.Column="0" x:Name="CardTotalPatients" Title="Total Patients" Value="0" Icon="👥" 
                                       TopColor="#4CAF50" IconBackground="#E8F5E9" Margin="0,0,10,0"/>
                    <local:SummaryCard Grid.Column="1" x:Name="CardTodayAppointments" Title="Today's Appointments" Value="0" Icon="📅" 
                                       TopColor="#2196F3" IconBackground="#E3F2FD" Margin="5,0,5,0"/>
                    <local:SummaryCard Grid.Column="2" x:Name="CardRemainingPatients" Title="Remaining Patient" Value="0" Icon="✓" 
                                       TopColor="#FF9800" IconBackground="#FFF3E0" TrendText="Requires attention" TrendColor="#FF9800" TrendIcon="⚠" Margin="5,0,5,0"/>
                    <local:SummaryCard Grid.Column="3" x:Name="CardExpiringMedicines" Title="Expiring Medicines" Value="0" Icon="⏰" 
                                       TopColor="#F44336" IconBackground="#FFEBEE" TrendText="Expiring within 30 days" TrendColor="#F44336" TrendIcon="🔴" Margin="10,0,0,0"/>
                </Grid>

                <!-- Patient Records -->
                <Border Background="White" CornerRadius="10" Padding="25">
                    <Border.Effect>
                        <DropShadowEffect Color="#000000" BlurRadius="10" ShadowDepth="2" Opacity="0.1"/>
                    </Border.Effect>
                    <StackPanel>
                        <TextBlock Text="Patient Records" FontSize="18" FontWeight="Bold" Foreground="#333" Margin="0,0,0,20"/>

                        <!-- Filters -->
                        <Grid Margin="0,0,0,20">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="2*"/>
                                <ColumnDefinition Width="10"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="10"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="10"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>

                            <TextBox x:Name="txtSearch" Grid.Column="0" Height="45" Padding="12" FontSize="14" TextChanged="txtSearch_TextChanged"/>
                            <ComboBox x:Name="cmbStatus" Grid.Column="2" Height="45" FontSize="14" SelectionChanged="Filter_Changed">
                                <ComboBoxItem Content="All Status" IsSelected="True"/>
                                <ComboBoxItem Content="Active"/>
                                <ComboBoxItem Content="Pending"/>
                                <ComboBoxItem Content="Completed"/>
                            </ComboBox>
                            <ComboBox x:Name="cmbGender" Grid.Column="4" Height="45" FontSize="14" SelectionChanged="Filter_Changed">
                                <ComboBoxItem Content="All Gender" IsSelected="True"/>
                                <ComboBoxItem Content="Male"/>
                                <ComboBoxItem Content="Female"/>
                            </ComboBox>
                            <Button Grid.Column="6" Content="🔍 Search" Background="#17a2b8" Foreground="White" Padding="20,12" FontSize="14" Click="Search_Click"/>
                        </Grid>

                        <Grid Margin="0,0,0,15">
                            <TextBlock Text="Patient List" FontSize="16" FontWeight="Bold"/>
                            <TextBlock x:Name="txtPatientCount" Text="Showing 0-0 of 0" FontSize="12" Foreground="#999" HorizontalAlignment="Right"/>
                        </Grid>

                        <!-- DataGrid -->
                        <DataGrid x:Name="dgPatients" AutoGenerateColumns="False" IsReadOnly="True" RowHeight="70" 
                                  HeadersVisibility="Column" GridLinesVisibility="None" BorderBrush="#E0E0E0" BorderThickness="1"
                                  RowBackground="White" AlternatingRowBackground="#FAFAFA">
                            <DataGrid.ColumnHeaderStyle>
                                <Style TargetType="DataGridColumnHeader">
                                    <Setter Property="Background" Value="#F5F5F5"/>
                                    <Setter Property="Padding" Value="15,12"/>
                                    <Setter Property="FontWeight" Value="Bold"/>
                                    <Setter Property="FontSize" Value="12"/>
                                </Style>
                            </DataGrid.ColumnHeaderStyle>
                            <DataGrid.Columns>
                                <DataGridTemplateColumn Header="PATIENT INFO" Width="200">
                                    <DataGridTemplateColumn.CellTemplate>
                                        <DataTemplate>
                                            <StackPanel Orientation="Horizontal">
                                                <Border Width="40" Height="40" CornerRadius="20" Background="#4CAF50" Margin="0,0,12,0">
                                                    <TextBlock Text="{Binding Initials}" Foreground="White" FontWeight="Bold" FontSize="14" 
                                                               HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                                </Border>
                                                <StackPanel VerticalAlignment="Center">
                                                    <TextBlock Text="{Binding FullName}" FontSize="14" FontWeight="SemiBold"/>
                                                    <TextBlock Text="{Binding AgeDisplay}" FontSize="12" Foreground="#757575"/>
                                                </StackPanel>
                                            </StackPanel>
                                        </DataTemplate>
                                    </DataGridTemplateColumn.CellTemplate>
                                </DataGridTemplateColumn>
                                <DataGridTextColumn Header="PATIENT ID" Binding="{Binding PatientId}" Width="120"/>
                                <DataGridTemplateColumn Header="CONTACT" Width="180">
                                    <DataGridTemplateColumn.CellTemplate>
                                        <DataTemplate>
                                            <StackPanel>
                                                <TextBlock Text="{Binding Contact}" FontSize="13"/>
                                                <TextBlock Text="{Binding Email}" FontSize="12" Foreground="#757575"/>
                                            </StackPanel>
                                        </DataTemplate>
                                    </DataGridTemplateColumn.CellTemplate>
                                </DataGridTemplateColumn>
                                <DataGridTemplateColumn Header="BIRTHDATE" Width="140">
                                    <DataGridTemplateColumn.CellTemplate>
                                        <DataTemplate>
                                            <StackPanel>
                                                <TextBlock Text="{Binding BirthDate, StringFormat='{}{0:MMMM dd, yyyy}'}" FontSize="13"/>
                                                <TextBlock Text="{Binding PrimaryDiagnosis}" FontSize="11" Foreground="#999"/>
                                            </StackPanel>
                                        </DataTemplate>
                                    </DataGridTemplateColumn.CellTemplate>
                                </DataGridTemplateColumn>
                                <DataGridTextColumn Header="GENDER" Binding="{Binding Gender}" Width="100"/>
                                <DataGridTemplateColumn Header="LAST VISIT" Width="150">
                                    <DataGridTemplateColumn.CellTemplate>
                                        <DataTemplate>
                                            <StackPanel>
                                                <TextBlock Text="{Binding LastVisit, StringFormat='{}{0:MMMM dd, yyyy}'}" FontSize="13"/>
                                                <TextBlock Text="{Binding PrimaryDiagnosis}" FontSize="11" Foreground="#999"/>
                                            </StackPanel>
                                        </DataTemplate>
                                    </DataGridTemplateColumn.CellTemplate>
                                </DataGridTemplateColumn>
                                <DataGridTemplateColumn Header="STATUS" Width="130">
                                    <DataGridTemplateColumn.CellTemplate>
                                        <DataTemplate>
                                            <Border Background="{Binding StatusBackground}" Padding="10,6" CornerRadius="12" HorizontalAlignment="Center">
                                                <TextBlock Text="{Binding Status}" Foreground="{Binding StatusForeground}" FontSize="12" FontWeight="Bold"/>
                                            </Border>
                                        </DataTemplate>
                                    </DataGridTemplateColumn.CellTemplate>
                                </DataGridTemplateColumn>
                                <DataGridTemplateColumn Header="ACTIONS" Width="220">
                                    <DataGridTemplateColumn.CellTemplate>
                                        <DataTemplate>
                                            <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                                                <!-- Tag binds to Id (int) so code-behind can cast to int -->
                                                <Button Content="👁️ View" Background="#6c757d" Foreground="White" Style="{StaticResource ActionBtn}" Click="View_Click" Tag="{Binding Id}"/>
                                                <Button Content="✏️ Edit" Background="#ffc107" Foreground="#333" Style="{StaticResource ActionBtn}" Click="Edit_Click" Tag="{Binding Id}"/>
                                                <Button Content="🗄️ Archive" Background="#dc3545" Foreground="White" Style="{StaticResource ActionBtn}" Click="Archive_Click" Tag="{Binding Id}"/>
                                            </StackPanel>
                                        </DataTemplate>
                                    </DataGridTemplateColumn.CellTemplate>
                                </DataGridTemplateColumn>
                            </DataGrid.Columns>
                        </DataGrid>

                        <!-- Pagination -->
                        <Grid Margin="0,20,0,0">
                            <StackPanel x:Name="paginationPanel" Orientation="Horizontal" HorizontalAlignment="Right"/>
                        </Grid>
                    </StackPanel>
                </Border>
            </StackPanel>
        </ScrollViewer>

        <!-- View Patient Dialog -->
        <Grid x:Name="viewDialog" Background="#80000000" Visibility="Collapsed" HorizontalAlignment="Center" VerticalAlignment="Center">
            <Border Background="White" Width="600" MaxHeight="700" CornerRadius="12" Padding="30">
                <Border.Effect>
                    <DropShadowEffect BlurRadius="20" ShadowDepth="5" Opacity="0.3"/>
                </Border.Effect>
                <ScrollViewer VerticalScrollBarVisibility="Auto">
                    <StackPanel>
                        <Grid Margin="0,0,0,20">
                            <TextBlock Text="Patient Details" FontSize="22" FontWeight="Bold" Foreground="#2E7D32"/>
                            <Button Content="✕" Width="35" Height="35" FontSize="18" Background="Transparent" Foreground="#666" 
                                    BorderThickness="0" Cursor="Hand" HorizontalAlignment="Right" Click="CloseViewDialog_Click"/>
                        </Grid>
                        <StackPanel x:Name="patientDetailsPanel"/>
                    </StackPanel>
                </ScrollViewer>
            </Border>
        </Grid>
    </Grid>
</UserControl>
